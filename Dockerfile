################################################################################
# BUILDER IMAGE
################################################################################

FROM golang:1.23 AS builder
ARG VERSION

# ------------------------------------------------------------------------------
# Define and create working directory
# ------------------------------------------------------------------------------

ENV APP_HOME=/app
RUN mkdir -p ${APP_HOME}
WORKDIR ${APP_HOME}

# ------------------------------------------------------------------------------
# Copy source code
# ------------------------------------------------------------------------------

COPY . .

# ------------------------------------------------------------------------------
# Build
# ------------------------------------------------------------------------------

RUN CGO_ENABLED=0 go build -a -o /outerspace-go \
    -ldflags "-s -w -X main.Version=${VERSION} -X main.BuildTime=$(TZ=UTC date +%Y-%m-%dT%H:%M:%S%z)"

################################################################################
# RELEASE IMAGE
################################################################################

FROM docker.io/bitnami/minideb:buster

# ------------------------------------------------------------------------------
# Install persistent dependencies
# ------------------------------------------------------------------------------

ENV PERSISTENT_DEPS="curl ca-certificates"
RUN install_packages ${PERSISTENT_DEPS}

# ------------------------------------------------------------------------------
# Define working directory & user
# ------------------------------------------------------------------------------

ENV APP_HOME=/app
ARG APP_USER=1001
WORKDIR ${APP_HOME}

# ------------------------------------------------------------------------------
# Copy built application
# ------------------------------------------------------------------------------

COPY --from=builder --chown=${APP_USER} /outerspace-go ./outerspace-go
RUN chmod +x ./outerspace-go

# ------------------------------------------------------------------------------
# Define user, exposed ports, additional env vars, entrypoint and cmd
# ------------------------------------------------------------------------------

USER ${APP_USER}
EXPOSE 8443 8080
CMD ["/app/outerspace-go"]
